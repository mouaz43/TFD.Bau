<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Galerie — TFD</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="icon" type="image/png" href="/assets/img/favicon-64.png" sizes="64x64">

  <!-- Icon sprite (no external assets) -->
  <svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden">
    <defs>
      <symbol id="i-calendar" viewBox="0 0 24 24">
        <path fill="currentColor" d="M7 2h2v2h6V2h2v2h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h3V2zm15 8H2v10a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1V10zM3 9h18V6a1 1 0 0 0-1-1h-3v2h-2V5H9v2H7V5H4a1 1 0 0 0-1 1v3z"/>
      </symbol>
      <symbol id="i-pin" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12 2a7 7 0 0 1 7 7c0 5.25-7 13-7 13S5 14.25 5 9a7 7 0 0 1 7-7zm0 9.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
      </symbol>
      <symbol id="i-ruler" viewBox="0 0 24 24">
        <path fill="currentColor" d="M3 16.5 16.5 3 21 7.5 7.5 21 3 16.5zm11.06-8.48 1.41 1.41-.71.71-1.41-1.41.71-.71zm2.83-2.83 1.41 1.41-.71.71-1.41-1.41.71-.71zM10.3 11.78l1.41 1.41-.7.71-1.42-1.41.71-.71zm-2.12 2.12 1.41 1.41-.71.71-1.41-1.41.71-.71z"/>
      </symbol>
      <symbol id="i-time" viewBox="0 0 24 24">
        <path fill="currentColor" d="M12 1a11 11 0 1 1 0 22A11 11 0 0 1 12 1m1 6h-2v6l5 3 .9-1.45-3.9-2.3V7z"/>
      </symbol>
      <symbol id="i-tag" viewBox="0 0 24 24">
        <path fill="currentColor" d="M21.41 11.58 12.41 2.58A2 2 0 0 0 11 2H4a2 2 0 0 0-2 2v7a2 2 0 0 0 .59 1.41l9 9a2 2 0 0 0 2.82 0l7-7a2 2 0 0 0 0-2.83zM7.5 7A1.5 1.5 0 1 1 6 5.5 1.5 1.5 0 0 1 7.5 7z"/>
      </symbol>
      <symbol id="i-image" viewBox="0 0 24 24">
        <path fill="currentColor" d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zM8.5 11.5A2.5 2.5 0 1 1 11 9a2.5 2.5 0 0 1-2.5 2.5zM5 19l4.5-6 3.5 4.5 2.5-3L19 19H5z"/>
      </symbol>
    </defs>
  </svg>

  <style>
    /* ====== keep existing admin styles ====== */
    .admin-wrap{display:none}
    .admin-wrap.authed{display:block}
    .admin-card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-top:20px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}
    input,select{background:#0F131A;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:10px}
    .delete-btn{border:1px solid var(--line);background:#1a1010;color:#ffb0b0;padding:6px 8px;border-radius:10px;font-weight:800;cursor:pointer}
    .card .top-right{position:absolute;right:12px;top:12px}

    /* ====== slider with filmstrip ====== */
    .slider{position:relative;overflow:hidden;border-radius:14px;background:#0b0f15}
    .slider-track{display:flex;will-change:transform;transition:transform .35s ease}
    .slider .slide{flex:0 0 100%;user-select:none}
    .slider .slide img{width:100%;height:100%;display:block;object-fit:cover}
    /* .slider{aspect-ratio:16/9} */

    .slider-nav{position:absolute;inset:0;pointer-events:none}
    .slider-btn{
      position:absolute;top:50%;transform:translateY(-50%);
      background:rgba(0,0,0,.35);backdrop-filter:blur(4px);
      border:1px solid rgba(255,255,255,.12);color:#fff;
      width:40px;height:40px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:20px;pointer-events:auto;cursor:pointer
    }
    .slider-btn:hover{background:rgba(0,0,0,.55)}
    .slider-prev{left:10px}
    .slider-next{right:10px}

    .slider-count{
      position:absolute;right:10px;top:10px;
      background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.15);
      color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;line-height:1
    }

    .slider-dots{
      position:absolute;left:0;right:0;bottom:8px;display:flex;gap:6px;
      align-items:center;justify-content:center;pointer-events:auto
    }
    .slider-dot{
      width:8px;height:8px;border-radius:999px;border:1px solid rgba(255,255,255,.5);
      background:rgba(255,255,255,.15);cursor:pointer
    }
    .slider-dot.active{background:#fff;border-color:#fff;width:20px;transition:width .2s}
    .slider.grabbing .slider-track{transition:none;cursor:grabbing}

    .slider-thumbs{
      display:flex;gap:8px;overflow:auto;padding:8px;margin-top:10px;
      border:1px solid var(--line);border-radius:12px;background:var(--card)
    }
    .slider-thumb{
      flex:0 0 auto;width:82px;height:58px;border-radius:8px;overflow:hidden;
      border:1px solid var(--line);opacity:.7;cursor:pointer
    }
    .slider-thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .slider-thumb.active{opacity:1;border-color:#fff}

    /* ====== elegant info panel ====== */
    .project-info{margin-top:14px}
    .project-top{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#0F131A}
    .pill svg{width:14px;height:14px;opacity:.9}

    .meta-grid{
      margin-top:12px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px
    }
    @media(max-width:900px){.meta-grid{grid-template-columns:repeat(2,1fr)}}
    .meta{
      background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px
    }
    .meta .k{display:flex;align-items:center;gap:6px;font-size:12px;color:#97a2b0}
    .meta .k svg{width:14px;height:14px}
    .meta .v{font-weight:700;margin-top:4px}

    .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .badge{border-radius:999px;padding:6px 10px;border:1px solid var(--line);background:#0F131A}

    .divider{height:1px;background:var(--line);margin:12px 0}
  </style>
</head>
<body class="logo-bg">
  <!-- NAV -->
  <nav class="nav"><div class="container bar">
    <button class="menu-btn" id="menuToggle" aria-label="Menü" aria-expanded="false"><span class="bars"></span><span>Menü</span></button>
    <a class="brand" href="/index.html" aria-label="Startseite">
      <img class="logo-img" src="/assets/img/tfd-logo-3d.png" alt="TFD Logo"><strong>TFD</strong>
    </a>
    <div class="spacer"></div>
  </div></nav>

  <div class="menu-panel" id="menuPanel" aria-hidden="true">
    <div class="menu-head"><div class="mini-brand"><strong>Menü</strong></div><button class="menu-close" id="menuClose">Schließen ✕</button></div>
    <nav class="menu-links">
      <a href="/index.html">Start</a><a href="/leistungen.html">Leistungen</a>
      <a href="/galerie.html">Galerie</a><a href="/faq.html">FAQ</a>
      <a class="cta" href="/kontakt.html">Kontakt</a>
    </nav>
    <div class="menu-quick">
      <a class="primary" href="mailto:AHMAD.MAMO@gmail.com?subject=Anfrage%20%E2%80%93%20TFD&body=Hallo%20TFD%2C%20ich%20habe%20eine%20Anfrage%20zu%3A%20">E-Mail</a>
      <a href="tel:+4915770070701">Anrufen</a>
      <a href="https://wa.me/4915770070701?text=Hallo%20TFD%2C%20ich%20habe%20eine%20Anfrage." target="_blank" rel="noopener">WhatsApp</a>
    </div>
    <div class="menu-footer"><a href="/legal/impressum.html">Impressum</a><a href="/legal/datenschutz.html">Datenschutz</a></div>
  </div>
  <div class="menu-backdrop" id="menuBackdrop"></div>

  <main class="container">
    <section class="section">
      <div class="row">
        <h1>Galerie</h1>
        <select id="filter" class="btn" onchange="renderGallery(this.value, isAuthed)">
          <option value="alle">Alle Kategorien</option>
          <option value="innenausbau">Innenausbau</option>
          <option value="trockenbau">Trockenbau</option>
          <option value="bodenleger">Bodenleger</option>
          <option value="gartenarbeit">Gartenarbeit</option>
        </select>
      </div>
      <div id="gallery" class="grid" style="grid-template-columns:1fr; gap:20px"></div>
    </section>

    <!-- Login + Admin -->
    <section class="section">
      <div class="card" style="display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px">
        <div><strong>Nur für Inhaber:</strong> <span class="muted">Einloggen mit GitHub-Token (wird nur im Speicher gehalten).</span></div>
        <div class="controls">
          <button class="btn" id="loginBtn">Login</button>
          <button class="btn" id="logoutBtn" style="display:none">Logout</button>
        </div>
      </div>

      <div class="admin-wrap" id="adminWrap">
        <div class="admin-card">
          <h2>Neues Projekt</h2>
          <div class="grid-3">
            <div><label>ID</label><input id="f_id" placeholder="innenausbau-ffm-02"></div>
            <div><label>Kategorie</label>
              <select id="f_cat">
                <option value="innenausbau">innenausbau</option>
                <option value="trockenbau">trockenbau</option>
                <option value="bodenleger">bodenleger</option>
                <option value="gartenarbeit">gartenarbeit</option>
              </select>
            </div>
            <div><label>Datum (YYYY-MM)</label><input id="f_date" placeholder="2025-09"></div>
          </div>
          <div class="grid-2" style="margin-top:12px">
            <div><label>Titel</label><input id="f_title" placeholder="Innenausbau — Wohnung Innenstadt"></div>
            <div><label>Ort</label><input id="f_loc" placeholder="Frankfurt am Main"></div>
          </div>
          <div class="grid-2" style="margin-top:12px">
            <div><label>Fläche (m²)</label><input id="f_qm" type="number" min="0" step="1" placeholder="48"></div>
            <div><label>Dauer (Tage)</label><input id="f_days" type="number" min="0" step="1" placeholder="7"></div>
          </div>

          <!-- multiple images -->
          <div style="margin-top:12px">
            <label>Galerie Bilder (mehrere erlaubt)</label>
            <input id="f_images" type="file" accept="image/*" multiple>
            <div class="muted" style="margin-top:6px">Tipp: 3–12 Bilder, Reihenfolge der Auswahl = Reihenfolge im Slider.</div>
          </div>

          <div style="margin-top:12px"><label>Highlights (Komma-getrennt)</label><input id="f_high" placeholder="Feinspachtel Q3, Neue Decke, Saubere Kanten"></div>
          <div class="row" style="margin-top:12px">
            <button class="btn primary" id="addBtn">Projekt speichern</button>
            <span class="muted" id="adminStatus"></span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer"><div class="container">© <span id="year"></span> TFD · <a href="/legal/impressum.html">Impressum</a> · <a href="/legal/datenschutz.html">Datenschutz</a></div></footer>

  <script src="/assets/js/main.js"></script>
  <!-- removed: /assets/js/ba-slider.js -->

  <script>
    /* ====== CONFIG ====== */
    const OWNER = "mouaz43";
    const REPO  = "TFD.Bau";
    const BRANCH = "main";
    const JSON_PATH = "content/project.json";
    const UPLOAD_DIR = "assets/uploads/";

    /* ====== STATE ====== */
    let TOKEN = null;
    let isAuthed = false;
    let projectsSha = null;

    /* ====== HELPERS ====== */
    function fmtMonth(yymm){
      if(!yymm) return '';
      const [y,m] = yymm.split('-').map(Number);
      if(!y||!m) return yymm;
      const d = new Date(y, m-1, 1);
      return d.toLocaleDateString('de-DE',{month:'long', year:'numeric'});
    }
    function safeNum(n){ return (typeof n==='number' && !isNaN(n)) ? n : null; }

    /* ====== PUBLIC LOAD ====== */
    async function loadPublicProjects(){
      try{
        const res = await fetch('/content/project.json?ts='+Date.now(), {cache:'no-store'});
        const data = await res.json();
        return Array.isArray(data) ? data : (data.items || []);
      }catch(e){ console.error(e); return []; }
    }

    function tags(list){
      if(!list || !list.length) return '';
      return '<div class="badges">' +
        list.map(t => `<span class="badge">${t}</span>`).join('') + '</div>';
    }

    /* ====== SLIDER MARKUP (with filmstrip) ====== */
    function sliderHTML(p, uid){
      const imgs = Array.isArray(p.images) && p.images.length
        ? p.images
        : [p.before, p.after].filter(Boolean);
      if (!imgs.length) return '';

      const slides = imgs.map((src, i) =>
        `<div class="slide"><img src="${src}" alt="${p.title || 'Projekt'} – Bild ${i+1}" loading="lazy" decoding="async"></div>`
      ).join('');

      const dots = imgs.map((_, i) =>
        `<button class="slider-dot" data-idx="${i}" aria-label="Bild ${i+1}"></button>`
      ).join('');

      const thumbs = imgs.map((src, i) =>
        `<button class="slider-thumb" data-idx="${i}" aria-label="Bild ${i+1}">
           <img src="${src}" alt="Vorschau ${i+1}" loading="lazy" decoding="async">
         </button>`
      ).join('');

      return `
        <div class="slider" id="slider_${uid}" tabindex="0" aria-roledescription="Karussell">
          <div class="slider-track">${slides}</div>
          <div class="slider-nav" aria-hidden="true">
            <button class="slider-btn slider-prev" type="button" aria-label="Vorheriges Bild">‹</button>
            <button class="slider-btn slider-next" type="button" aria-label="Nächstes Bild">›</button>
            <div class="slider-dots">${dots}</div>
            <div class="slider-count"><svg width="14" height="14" style="vertical-align:-2px"><use href="#i-image"/></svg> <span data-role="count">1</span>/<span>${imgs.length}</span></div>
          </div>
        </div>
        <div class="slider-thumbs" id="thumbs_${uid}">${thumbs}</div>
      `;
    }

    /* ====== INFO MARKUP ====== */
    function infoHTML(p){
      const qm = p.metrics && safeNum(p.metrics.qm);
      const tage = p.metrics && safeNum(p.metrics.dauer_tage);
      const dateText = fmtMonth(p.date);

      const cat = (p.category||'').trim();
      return `
        <div class="project-info">
          <div class="project-top">
            ${cat ? `<span class="pill"><svg width="14" height="14"><use href="#i-tag"/></svg>${cat}</span>`:''}
            ${p.location ? `<span class="pill"><svg width="14" height="14"><use href="#i-pin"/></svg>${p.location}</span>`:''}
          </div>

          <div class="meta-grid">
            ${dateText ? `
              <div class="meta">
                <div class="k"><svg><use href="#i-calendar"/></svg>Datum</div>
                <div class="v">${dateText}</div>
              </div>`:''}
            ${qm!=null ? `
              <div class="meta">
                <div class="k"><svg><use href="#i-ruler"/></svg>Fläche</div>
                <div class="v">${qm} m²</div>
              </div>`:''}
            ${tage!=null ? `
              <div class="meta">
                <div class="k"><svg><use href="#i-time"/></svg>Dauer</div>
                <div class="v">${tage} Tage</div>
              </div>`:''}
            ${p.title ? `
              <div class="meta">
                <div class="k">Projekt</div>
                <div class="v">${p.title}</div>
              </div>`:''}
          </div>

          ${tags(p.highlights)}
        </div>
      `;
    }

    /* ====== CARD ====== */
    function card(p, idx, authed){
      return `<div class="card" style="position:relative">
        ${authed? `<div class="top-right"><button class="delete-btn" onclick="adminDelete('${p.id}')">Löschen</button></div>`:''}
        <div class="row"><strong>${p.title||'Projekt'}</strong><span class="muted">${p.location||''}</span></div>
        ${sliderHTML(p, idx)}
        <div class="divider"></div>
        ${infoHTML(p)}
      </div>`;
    }

    async function renderGallery(filter='alle', authed=false){
      const mount = document.getElementById('gallery');
      const data = await loadPublicProjects();
      const list = data.filter(p => filter==='alle' ? true : (p.category||'').toLowerCase()===filter);
      mount.innerHTML = list.map((p,i)=>card(p,i,authed)).join('') || '<div class="muted">Noch keine Projekte.</div>';
      initAllSliders();
    }

    /* ====== SLIDER LOGIC ====== */
    function initAllSliders(){
      document.querySelectorAll('.slider').forEach(initSlider);
    }

    function initSlider(root){
      const track = root.querySelector('.slider-track');
      const slides = Array.from(root.querySelectorAll('.slide'));
      const prevBtn = root.querySelector('.slider-prev');
      const nextBtn = root.querySelector('.slider-next');
      const dots = Array.from(root.querySelectorAll('.slider-dot'));
      const countEl = root.querySelector('[data-role="count"]');
      const uid = root.id.split('_')[1];
      const thumbsWrap = document.getElementById('thumbs_'+uid);
      const thumbs = thumbsWrap ? Array.from(thumbsWrap.querySelectorAll('.slider-thumb')) : [];

      let index = 0;
      let startX = 0;
      let currentX = 0;
      let dragging = false;

      function clamp(i){ return Math.max(0, Math.min(i, slides.length-1)); }
      function setIndex(i){
        index = clamp(i);
        track.style.transform = `translateX(${-index*100}%)`;
        dots.forEach((d,k)=>d.classList.toggle('active', k===index));
        thumbs.forEach((t,k)=>t.classList.toggle('active', k===index));
        if(countEl) countEl.textContent = String(index+1);
        // ensure active thumb is in view
        if(thumbsWrap && thumbs[index]){
          const t = thumbs[index];
          const left = t.offsetLeft;
          const right = left + t.offsetWidth;
          if (left < thumbsWrap.scrollLeft) thumbsWrap.scrollLeft = left - 8;
          else if (right > thumbsWrap.scrollLeft + thumbsWrap.clientWidth)
            thumbsWrap.scrollLeft = right - thumbsWrap.clientWidth + 8;
        }
      }
      function next(){ setIndex(index+1); }
      function prev(){ setIndex(index-1); }

      dots.forEach(d=> d.addEventListener('click', ()=> setIndex(Number(d.dataset.idx)||0)));
      thumbs.forEach(t=> t.addEventListener('click', ()=> setIndex(Number(t.dataset.idx)||0)));
      if(thumbs[0]) thumbs[0].classList.add('active');

      prevBtn.addEventListener('click', prev);
      nextBtn.addEventListener('click', next);

      root.addEventListener('keydown', (e)=>{
        if(e.key==='ArrowRight'){ e.preventDefault(); next(); }
        if(e.key==='ArrowLeft'){ e.preventDefault(); prev(); }
      });

      const onDown = (e)=>{
        dragging = true; root.classList.add('grabbing');
        startX = (e.touches ? e.touches[0].clientX : e.clientX); currentX = startX;
      };
      const onMove = (e)=>{
        if(!dragging) return;
        const x = (e.touches ? e.touches[0].clientX : e.clientX);
        currentX = x;
        const dx = currentX - startX;
        const pct = dx / root.clientWidth * 100;
        track.style.transform = `translateX(${-(index*100) + pct}%)`;
      };
      const onUp = ()=>{
        if(!dragging) return;
        const dx = currentX - startX;
        const threshold = Math.min(80, Math.max(40, root.clientWidth*0.12));
        if(Math.abs(dx) > threshold){ if(dx < 0) next(); else prev(); }
        else setIndex(index);
        dragging = false; root.classList.remove('grabbing');
      };

      slides.forEach(s=> s.addEventListener('dragstart', e=>e.preventDefault()));
      root.addEventListener('mousedown', onDown);
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);
      root.addEventListener('touchstart', onDown, {passive:true});
      root.addEventListener('touchmove', onMove, {passive:true});
      root.addEventListener('touchend', onUp);
      window.addEventListener('resize', ()=> setIndex(index));

      setIndex(0);
    }

    /* ====== GITHUB API HELPERS ====== */
    const gh = (path, opts={}) =>
      fetch(`https://api.github.com${path}`, {
        ...opts,
        headers: {
          "Accept":"application/vnd.github+json",
          ...(opts.headers||{}),
          ...(TOKEN ? {"Authorization":`token ${TOKEN}`} : {})
        }
      });
    const utf8ToB64 = str => btoa(unescape(encodeURIComponent(str)));
    const b64ToStr  = b64 => decodeURIComponent(escape(atob(b64.replace(/\n/g,''))));
    const contentsUrl = p => `/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(p)}?ref=${BRANCH}`;
    const putUrl      = p => `/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(p)}`;

    async function ensureProjectsFile(){
      const r = await gh(contentsUrl(JSON_PATH));
      if (r.status === 404){
        const create = await gh(putUrl(JSON_PATH), {
          method:"PUT",
          body: JSON.stringify({ message: "init project.json", content: utf8ToB64("[]\n"), branch: BRANCH })
        });
        if(!create.ok){ throw new Error("Konnte project.json nicht anlegen: " + await create.text()); }
        const j = await create.json(); projectsSha = j.content.sha; return [];
      }
      if(!r.ok){ throw new Error("project.json nicht gefunden (API) — " + await r.text()); }
      const j = await r.json(); projectsSha = j.sha;
      try { return JSON.parse(b64ToStr(j.content)); } catch { return []; }
    }

    async function uploadFile(prefix, file){
      const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
      const name = prefix + Date.now() + '.' + ext;
      const b64 = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result.split(',')[1]); r.onerror=rej; r.readAsDataURL(file); });
      const r = await gh(putUrl(name), {
        method:"PUT",
        body: JSON.stringify({ message:`upload image: ${name}`, content:b64, branch:BRANCH })
      });
      if(!r.ok){ throw new Error("Upload fehlgeschlagen: " + await r.text()); }
      return "/"+name;
    }

    async function saveProjectsArray(arr, msg){
      const content = JSON.stringify(arr, null, 2) + "\n";
      const r = await gh(putUrl(JSON_PATH), {
        method:"PUT",
        body: JSON.stringify({ message: msg, content: utf8ToB64(content), branch: BRANCH, sha: projectsSha })
      });
      if(!r.ok){ throw new Error("Speichern fehlgeschlagen: " + await r.text()); }
      const j = await r.json(); projectsSha = j.content.sha;
    }

    /* ====== ADMIN UI ====== */
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminWrap = document.getElementById('adminWrap');
    const statusEl = document.getElementById('adminStatus');

    loginBtn.addEventListener('click', async () => {
      const token = prompt("Füge deinen GitHub Fine-grained Token ein (Repo: TFD.Bau, Contents: Read & write):");
      if(!token) return;
      TOKEN = token.trim();
      try{
        const me = await gh("/user"); if(!me.ok) throw 0;
        isAuthed = true;
        loginBtn.style.display='none'; logoutBtn.style.display='inline-flex';
        adminWrap.classList.add('authed');
        renderGallery(document.getElementById('filter').value, true);
      }catch{ alert("Token ungültig oder keine Rechte."); TOKEN = null; }
    });

    logoutBtn.addEventListener('click', () => {
      TOKEN = null; isAuthed = false;
      loginBtn.style.display='inline-flex'; logoutBtn.style.display='none';
      adminWrap.classList.remove('authed');
      renderGallery(document.getElementById('filter').value, false);
    });

    document.getElementById('addBtn').addEventListener('click', async () => {
      if(!TOKEN){ alert("Bitte einloggen."); return; }
      const id = document.getElementById('f_id').value.trim();
      if(!id){ alert("ID ist erforderlich"); return; }

      const category = document.getElementById('f_cat').value;
      const date = document.getElementById('f_date').value.trim();
      const title = document.getElementById('f_title').value.trim();
      const location = document.getElementById('f_loc').value.trim();
      const qm = document.getElementById('f_qm').value;
      const days = document.getElementById('f_days').value;
      const highlights = document.getElementById('f_high').value.split(',').map(s=>s.trim()).filter(Boolean);
      const files = Array.from(document.getElementById('f_images').files||[]);
      if(files.length === 0){ alert("Bitte mindestens ein Bild auswählen."); return; }

      statusEl.textContent = "Lade hoch…";
      try{
        const arr = await ensureProjectsFile();
        if(arr.find(x=>x.id===id)) throw new Error("ID existiert bereits");

        const base = UPLOAD_DIR + id + "-img-";
        const urls = [];
        for (let i=0;i<files.length;i++){
          const u = await uploadFile(base + (i+1) + "-", files[i]);
          urls.push(u);
        }

        arr.push({
          id, category, title, location, date,
          metrics: { qm: qm?Number(qm):undefined, dauer_tage: days?Number(days):undefined },
          images: urls,
          highlights
        });

        await saveProjectsArray(arr, `gallery: add ${id}`);
        statusEl.textContent = "Gespeichert.";
        ["f_id","f_date","f_title","f_loc","f_qm","f_days","f_high"].forEach(i=>document.getElementById(i).value="");
        document.getElementById('f_images').value="";
        renderGallery(document.getElementById('filter').value, true);
      }catch(e){ alert(e.message || e); statusEl.textContent = ""; }
    });

    /* boot */
    document.getElementById('year').textContent = new Date().getFullYear();
    renderGallery('alle');
  </script>
</body>
</html>
